{% extends "base.html" %}

{% block title %}图书长度偏好分析 - 豆瓣图书数据分析{% endblock %}

{% block content %}
<h1><i class="bi bi-book"></i> 图书长度偏好分析</h1>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <div class="chart-container" id="lengthPieChart">
        <div class="loading"><i class="bi bi-arrow-repeat"></i> 正在加载数据...</div>
    </div>
    <div class="chart-container" id="lengthBarChart">
        <div class="loading"><i class="bi bi-arrow-repeat"></i> 正在加载数据...</div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pieChart = echarts.init(document.getElementById('lengthPieChart'));
    const barChart = echarts.init(document.getElementById('lengthBarChart'));
    
    pieChart.showLoading();
    barChart.showLoading();
    
    fetch('/api/book-length-preference')
        .then(response => response.json())
        .then(data => {
            pieChart.hideLoading();
            barChart.hideLoading();
            
            if (data.success && data.data.length > 0) {
                const categories = data.data.map(item => item.length_category);
                const counts = data.data.map(item => item.book_count);
                const avgRatings = data.data.map(item => item.avg_rating);
                const avgRatingCounts = data.data.map(item => item.avg_rating_count);
                
                // 饼图配置
                const pieOption = {
                    title: {
                        text: '图书数量分布',
                        left: 'center',
                        textStyle: {
                            fontSize: 16,
                            fontWeight: 'bold'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            return `${params.name}<br/>数量: ${params.value} 本<br/>占比: ${params.percent}%`;
                        }
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        top: 'center'
                    },
                    series: [
                        {
                            name: '图书数量',
                            type: 'pie',
                            radius: '60%',
                            center: ['60%', '50%'],
                            data: categories.map((cat, index) => ({
                                name: cat,
                                value: counts[index]
                            })),
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            itemStyle: {
                                borderRadius: 5,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}: {c}本'
                            }
                        }
                    ]
                };
                
                // 柱状图配置
                const barOption = {
                    title: {
                        text: '评分与评价人数分析',
                        left: 'center',
                        textStyle: {
                            fontSize: 16,
                            fontWeight: 'bold'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        },
                        formatter: function(params) {
                            let result = `${params[0].name}<br/>`;
                            result += `平均评分: ${params[0].value.toFixed(2)} ⭐<br/>`;
                            if (params[1]) {
                                result += `平均评价人数: ${Math.round(params[1].value)} 人`;
                            }
                            return result;
                        }
                    },
                    legend: {
                        data: ['平均评分', '平均评价人数'],
                        top: 30
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: categories,
                        axisLabel: {
                            fontSize: 11
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: '平均评分',
                            position: 'left',
                            max: 5,
                            nameTextStyle: {
                                color: '#5470c6'
                            }
                        },
                        {
                            type: 'value',
                            name: '平均评价人数',
                            position: 'right',
                            nameTextStyle: {
                                color: '#91cc75'
                            }
                        }
                    ],
                    series: [
                        {
                            name: '平均评分',
                            type: 'bar',
                            data: avgRatings,
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#83bff6'},
                                    {offset: 0.5, color: '#188df0'},
                                    {offset: 1, color: '#188df0'}
                                ])
                            }
                        },
                        {
                            name: '平均评价人数',
                            type: 'line',
                            yAxisIndex: 1,
                            data: avgRatingCounts,
                            lineStyle: {
                                color: '#91cc75',
                                width: 3
                            },
                            itemStyle: {
                                color: '#91cc75'
                            },
                            symbol: 'circle',
                            symbolSize: 6
                        }
                    ]
                };
                
                pieChart.setOption(pieOption);
                barChart.setOption(barOption);
            } else {
                document.getElementById('lengthPieChart').innerHTML = 
                    '<div style="text-align: center; color: #999; padding: 50px;">暂无数据</div>';
                document.getElementById('lengthBarChart').innerHTML = 
                    '<div style="text-align: center; color: #999; padding: 50px;">暂无数据</div>';
            }
        })
        .catch(error => {
            pieChart.hideLoading();
            barChart.hideLoading();
            console.error('Error:', error);
            document.getElementById('lengthPieChart').innerHTML = 
                '<div style="text-align: center; color: #f44336; padding: 50px;">数据加载失败</div>';
            document.getElementById('lengthBarChart').innerHTML = 
                '<div style="text-align: center; color: #f44336; padding: 50px;">数据加载失败</div>';
        });
    
    window.addEventListener('resize', function() {
        pieChart.resize();
        barChart.resize();
    });
});
</script>
{% endblock %}
